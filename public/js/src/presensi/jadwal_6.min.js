let date,cekIn,statusIn,keteranganIn,nilaiIn,geoIn,loactionIn,wifi,posisi,visitIdIn,cekOut,statusOut,keteranganOut,nilaiOut,geoOut,visitIdOut,dataPostAbsen;const visitLocal=localStorage.getItem("visite");visitLocal?(visitIdIn=visitLocal,visitIdOut=visitLocal):(visitIdIn="",visitIdOut="");const myHeaders=new Headers;myHeaders.append("Content-Type","application/json");let token=getCookie("token");token=token.split(".");let idData=atob(token[1]);idData=JSON.parse(idData),fetch("/api/presensi/jdldns",{method:"GET"}).then((response=>{if(!response.ok)throw response;return response.json()})).then((data=>{document.getElementById("Timecheckin").textContent=`${data.data.dnsType.start_min} - ${data.data.dnsType.start_max}`,document.getElementById("Timecheckout").textContent=`${data.data.dnsType.end_min} - ${data.data.dnsType.end_max}`,document.getElementById("jns_shift").textContent=data.data.dnsType.type,typeDns=data.data.typeDns,date=data.data.date,0===data.data.dnsType.state&&(Swal.fire({icon:"info",title:`Anda hari ini ${data.data.dnsType.type}`,text:"",buttons:!1,confirmButtonText:"OK",showCancelButton:!1,confirmButtonColor:"#3085d6"}),document.getElementById("checkin").disabled=!0)})).catch((error=>{error.json&&error.json().then((errorData=>{Swal.fire({icon:"warning",title:errorData.message,text:errorData.data,buttons:!1,confirmButtonText:"OK",showCancelButton:!1,confirmButtonColor:"#3085d6",allowOutsideClick:!1,allowEscapeKey:!1,allowEnterKey:!1}).then((result=>{result.isConfirmed&&(window.location.href="/")}))}))}));let intervalId=null;function check(state){if(!1===posisi)return window.location.href="/absen";if(void 0===geoIn)return Swal.fire({icon:"warning",title:"Mohon tunggu...",text:"Sedang menunggu data GPS",buttons:!1,showCancelButton:!1,confirmButtonColor:"#3085d6",allowOutsideClick:!1,allowEscapeKey:!1,allowEnterKey:!1});dataPostAbsen={state:state,type:typeDns,date:date,geoIn:geoIn,wifi:wifi,posisi:posisi,loactionIn:loactionIn,visitIdIn:visitIdIn},video.addEventListener("play",startDetection),loadModels().then(startVideo),document.getElementById("faceReactionLabel").textContent="Arahkan Kamera Wajah";new bootstrap.Modal(document.getElementById("faceReaction")).show()}const video=document.getElementById("video"),canvas=document.getElementById("canvas"),context=canvas.getContext("2d"),snapshot=document.getElementById("snapshot");let lastCaptureTime=0;const captureInterval=2e3;async function loadModels(){await faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.0.1/model")}async function startVideo(){try{const stream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:1024},facingMode:"environment"}});video.srcObject=stream}catch(error){}}async function detectFaces(){const detections=await faceapi.detectAllFaces(video,new faceapi.TinyFaceDetectorOptions);if(canvas.width=video.videoWidth,canvas.height=video.videoHeight,context.drawImage(video,0,0,canvas.width,canvas.height),faceapi.draw.drawDetections(canvas,detections),detections.length>0){const currentTime=Date.now();currentTime-lastCaptureTime>captureInterval&&(document.getElementById("ket").innerText="",autoCapture(),stopDetection(),lastCaptureTime=currentTime)}}function autoCapture(){const imageData=canvas.toDataURL("image/png");snapshot.src=imageData,sendImageToServer(imageData)}function sendImageToServer(imageData){const blob=base64ToBlob(imageData.replace(/^data:image\/(png|jpeg);base64,/,""),"image/jpeg");fetch(`https://fr.spairum.my.id/api/cdn/upload/fr/recognition?metadata=0_${idData.id}.json`,{method:"GET"}).then((response=>{if(!response.ok)throw new Error(`HTTP error! status: ${response.status}`);return response.json()})).then((data=>{matchFR(blob)})).catch((error=>{sendRecognition(blob)}))}function startDetection(){intervalId||(intervalId=setInterval(detectFaces,1e3))}function stopDetection(){intervalId&&(clearInterval(intervalId),intervalId=null)}async function sendRecognition(img){let form=new FormData;form.append("image",img,idData.nama+".jpg"),form.append("nik",idData.id),form.append("name",idData.nama);try{const response=await fetch("https://fr.spairum.my.id/api/cdn/upload/fr/recognition",{method:"POST",body:form});if(response.ok){await response.json()}startDetection()}catch(error){}}async function matchFR(img){let form=new FormData;form.append("image",img,idData.nama.replace(/[^\w]|_/g,"")+".jpg"),form.append("nik",idData.id),form.append("metadata","0_"+idData.id+".json");try{const response=await fetch("https://fr.spairum.my.id/api/cdn/upload/fr/recognition",{method:"PUT",body:form});if(response.ok){const result=await response.json();if(void 0!==result.output&&result.output.data){document.getElementById("ket").innerText=`HI ${idData.nama}`;try{const absenResponse=await fetch("/api/presensi/absen",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(dataPostAbsen)});if(absenResponse.ok){const absenResult=await absenResponse.json();Swal.fire({icon:"success",title:absenResult.message,text:absenResult.data}),getRiwayat(periode)}else{const errorData=await absenResponse.json();Swal.fire({icon:"warning",title:errorData.message,text:errorData.data})}}catch(absenError){}stopDetection(),bootstrap.Modal.getInstance(document.getElementById("faceReaction")).hide()}else startDetection(),document.getElementById("ket").innerText=" Mohon wajah anda tidak cocok dengan yang tersimpan di database, silahkan coba lagi."}}catch(error){}}function base64ToBlob(base64,contentType="",sliceSize=512){const byteCharacters=atob(base64),byteArrays=[];for(let offset=0;offset<byteCharacters.length;offset+=sliceSize){const slice=byteCharacters.slice(offset,offset+sliceSize),byteNumbers=new Array(slice.length);for(let i=0;i<slice.length;i++)byteNumbers[i]=slice.charCodeAt(i);const byteArray=new Uint8Array(byteNumbers);byteArrays.push(byteArray)}return new Blob(byteArrays,{type:contentType})}async function detectCameras(){try{const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});if(stream){stream.getTracks().forEach((track=>track.stop())),video.srcObject=null}}catch(error){alert("Please allow camera access.")}try{(await navigator.mediaDevices.enumerateDevices()).filter((device=>"videoinput"===device.kind))}catch(error){}}document.getElementById("faceReaction").addEventListener("hidden.bs.modal",(function(){video.pause(),video.srcObject=null,stopDetection()})),detectCameras();
