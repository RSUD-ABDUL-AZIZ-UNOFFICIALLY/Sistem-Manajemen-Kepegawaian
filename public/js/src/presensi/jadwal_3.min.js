let typeDns,date,cekIn,statusIn,keteranganIn,nilaiIn,geoIn,wifi,posisi,visitIdIn,cekOut,statusOut,keteranganOut,nilaiOut,geoOut,visitIdOut,dataPostAbsen;const visitLocal=localStorage.getItem("visite");visitLocal?(visitIdIn=visitLocal,visitIdOut=visitLocal):(visitIdIn="",visitIdOut="");const myHeaders=new Headers;myHeaders.append("Content-Type","application/json");let token=getCookie("token");token=token.split(".");let idData=atob(token[1]);idData=JSON.parse(idData),$.ajax({url:"/api/presensi/jdldns",method:"GET",success:function(response){$("#Timecheckin").text(response.data.dnsType.start_min+" - "+response.data.dnsType.start_max),$("#Timecheckout").text(response.data.dnsType.end_min+" - "+response.data.dnsType.end_max),$("#jns_shift").text(response.data.dnsType.type),typeDns=response.data.typeDns,date=response.data.date,0==response.data.dnsType.state&&(Swal.fire({icon:"info",title:"Anda hari ini "+response.data.dnsType.type,text:"",buttons:!1,confirmButtonText:"OK",showCancelButton:!1,confirmButtonColor:"#3085d6"}),$("#checkin").prop("disabled",!0))},error:function(error){Swal.fire({icon:"warning",title:error.responseJSON.message,text:error.responseJSON.data,buttons:!1,confirmButtonText:"OK",showCancelButton:!1,confirmButtonColor:"#3085d6",allowOutsideClick:!1,allowEscapeKey:!1,allowEnterKey:!1}).then((result=>{result.isConfirmed&&(window.location.href="/")}))}});let intervalId=null;function check(state){if(!1===posisi)return window.location.href="/absen";dataPostAbsen={state:state,type:typeDns,date:date,geoIn:geoIn,wifi:wifi,posisi:posisi,visitIdIn:visitIdIn},video.addEventListener("play",startDetection),loadModels().then(startVideo),$("#faceReactionLabel").text("Arahkan Kamera Wajah"),$("#faceReaction").modal("show")}const video=document.getElementById("video"),canvas=document.getElementById("canvas"),context=canvas.getContext("2d"),snapshot=document.getElementById("snapshot");let lastCaptureTime=0;const captureInterval=2e3;async function loadModels(){await faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.0.1/model")}async function startVideo(){try{const stream=await navigator.mediaDevices.getUserMedia({video:!0});video.srcObject=stream}catch(error){}}async function detectFaces(){const detections=await faceapi.detectAllFaces(video,new faceapi.TinyFaceDetectorOptions);if(canvas.width=video.videoWidth,canvas.height=video.videoHeight,context.drawImage(video,0,0,canvas.width,canvas.height),detections.length>0){const currentTime=Date.now();currentTime-lastCaptureTime>captureInterval&&(autoCapture(),lastCaptureTime=currentTime)}}function autoCapture(){const imageData=canvas.toDataURL("image/png");snapshot.src=imageData,sendImageToServer(imageData)}function sendImageToServer(imageData){const blob=base64ToBlob(imageData.replace(/^data:image\/(png|jpeg);base64,/,""),"image/jpeg");$.ajax({url:"https://fr.spairum.my.id/api/cdn/upload/fr/recognition?metadata=0_"+idData.id+".json",method:"GET",success:function(response){matchFR(blob)},error:function(error){sendRecognition(blob)}})}function startDetection(){intervalId||(intervalId=setInterval(detectFaces,100))}function stopDetection(){intervalId&&(clearInterval(intervalId),intervalId=null)}async function sendRecognition(img){let form=new FormData;form.append("image",img,idData.nama+".jpg"),form.append("nik",idData.id),form.append("name",idData.nama);let settings={url:"https://fr.spairum.my.id/api/cdn/upload/fr/recognition",method:"POST",processData:!1,mimeType:"multipart/form-data",contentType:!1,data:form};$.ajax(settings).done((function(response){response=JSON.parse(response)}))}async function matchFR(img){let form=new FormData;form.append("image",img,idData.nama+".jpg"),form.append("nik",idData.id),form.append("metadata","0_"+idData.id+".json");let settings={url:"https://fr.spairum.my.id/api/cdn/upload/fr/recognition",method:"PUT",processData:!1,mimeType:"multipart/form-data",contentType:!1,data:form};$.ajax(settings).done((function(response){null!=(response=JSON.parse(response)).output&&response.output.data&&($.ajax({url:"/api/presensi/absen",method:"POST",data:dataPostAbsen,success:function(response){Swal.fire({icon:"success",title:response.message,text:response.data})},error:function(error){Swal.fire({icon:"warning",title:error.responseJSON.message,text:error.responseJSON.data})}}),stopDetection(),$("#faceReaction").modal("hide"))}))}function base64ToBlob(base64,contentType="",sliceSize=512){const byteCharacters=atob(base64),byteArrays=[];for(let offset=0;offset<byteCharacters.length;offset+=sliceSize){const slice=byteCharacters.slice(offset,offset+sliceSize),byteNumbers=new Array(slice.length);for(let i=0;i<slice.length;i++)byteNumbers[i]=slice.charCodeAt(i);const byteArray=new Uint8Array(byteNumbers);byteArrays.push(byteArray)}return new Blob(byteArrays,{type:contentType})}async function detectCameras(){try{const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});if(stream){stream.getTracks().forEach((track=>track.stop())),video.srcObject=null}}catch(error){alert("Please allow camera access.")}try{const devices=await navigator.mediaDevices.enumerateDevices(),videoDevices=devices.filter((device=>"videoinput"===device.kind)),raw=JSON.stringify({appName:"SIMPEG",level:"info",message:"Deteksi kamera berhasil",metadata:{nik:idData.id,name:idData.nama,deviceInfo:videoDevices,devices:devices}}),requestOptions={method:"POST",headers:myHeaders,body:raw};await fetch("https://logs.spairum.my.id/api/logs",requestOptions)}catch(error){document.getElementById("cameraCount").textContent="Tidak dapat mendeteksi kamera.";const raw=JSON.stringify({appName:"SIMPEG",level:"error",message:"Deteksi kamera gagal",metadata:{nik:idData.id,name:idData.nama,error:error}}),requestOptions={method:"POST",headers:myHeaders,body:raw};await fetch("https://logs.spairum.my.id/api/logs",requestOptions)}}$("#faceReaction").on("hidden.bs.modal",(function(){video.pause(),video.srcObject=null,stopDetection()})),detectCameras();
